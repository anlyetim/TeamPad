// hooks/useKeyboardShortcuts.ts - Photoshop-style keyboard shortcuts for all tools and operations

import { useEffect } from 'react'
import { useHaloboardStore } from '@/lib/store'
import { getEditorRuntime } from '@/lib/editorRuntime'
import type { PhotoshopTool } from '@/lib/types'

export function useKeyboardShortcuts() {
  const {
    selectedIds,
    objects,
    setSelectedIds,
    copy,
    paste,
    duplicate,
    undo,
    redo,
    setActiveTool
  } = useHaloboardStore()

  const editorRuntime = getEditorRuntime()

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Skip if typing in input/textarea
      if (e.target instanceof HTMLTextAreaElement || e.target instanceof HTMLInputElement) return

      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0
      const cmdOrCtrl = isMac ? e.metaKey : e.ctrlKey

      // Photoshop Tool Shortcuts (single keys, no modifiers)
      if (!cmdOrCtrl && !e.altKey) {
        const toolMap: Record<string, any> = {
          'v': 'select',
          'b': 'brush',
          'e': 'eraser',
          't': 'text',
          'n': 'notes',
          's': 'shape',
          'i': 'image'
        }

        if (toolMap[e.key.toLowerCase()]) {
          e.preventDefault()
          setActiveTool(toolMap[e.key.toLowerCase()])
          return
        }
      }

      // Edit Operations (with Ctrl/Cmd)
      if (cmdOrCtrl) {
        switch (e.key.toLowerCase()) {
          case 'c': // Copy
            e.preventDefault()
            if (selectedIds.length > 0) {
              copy()
            }
            break

          case 'v': // Paste
            e.preventDefault()
            paste()
            break

          case 'd': // Duplicate
            e.preventDefault()
            if (selectedIds.length > 0) {
              duplicate()
            }
            break

          case 'a': // Select All
            e.preventDefault()
            setSelectedIds(objects.map(obj => obj.id))
            break

          case 'z': // Undo/Redo
            e.preventDefault()
            if (e.shiftKey) {
              redo()
            } else {
              undo()
            }
            break

          case 'y': // Redo (alternative)
            e.preventDefault()
            redo()
            break
        }
        return
      }

      // Transform Operations (no modifiers)
      switch (e.key) {
        case 'Escape':
          // Cancel current operation
          e.preventDefault()
          setSelectedIds([])
          break

        case 'Delete':
        case 'Backspace':
          // Delete selected objects
          e.preventDefault()
          selectedIds.forEach(id => {
            editorRuntime.deleteObject(id)
          })
          setSelectedIds([])
          break
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [selectedIds, objects, setSelectedIds, copy, paste, duplicate, undo, redo, setActiveTool, editorRuntime])
}

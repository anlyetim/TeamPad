"use client"

import { useState, useRef, useEffect } from "react"
import { useHaloboardStore } from "@/lib/store"
import { Slider } from "@/components/ui/slider"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { ScrollArea } from "@/components/ui/scroll-area"
import { 
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue 
} from "@/components/ui/select"
import { 
  Eye, EyeOff, Lock, LockOpen, ChevronDown, ChevronRight, ChevronUp, Plus, Trash2, 
  Minimize2, Maximize2, Send, RotateCcw, Clock,
  AlignLeft, AlignCenter, AlignRight, Type, Image as ImageIcon, Upload, ArrowUp, ArrowDown,
  Move
} from "lucide-react"
import { cn } from "@/lib/utils"

interface PanelSectionProps {
  title: string
  children: React.ReactNode
  className?: string
  defaultOpen?: boolean
}

function PanelSection({ title, children, className, defaultOpen = true }: PanelSectionProps) {
  const [isOpen, setIsOpen] = useState(defaultOpen)

  return (
    <div className={cn("rounded-xl border border-white/20 bg-white/70 shadow-lg backdrop-blur-xl dark:border-white/10 dark:bg-neutral-900/70", className)}>
      <div 
        className="flex items-center justify-between p-3 cursor-pointer hover:bg-black/5 dark:hover:bg-white/5 transition-colors rounded-t-xl"
        onClick={() => setIsOpen(!isOpen)}
      >
        <h3 className="text-sm font-semibold text-neutral-800 dark:text-neutral-200">{title}</h3>
        <Button variant="ghost" size="icon" className="size-6 h-6 w-6">
          {isOpen ? <Minimize2 className="size-3" /> : <Maximize2 className="size-3" />}
        </Button>
      </div>
      {isOpen && (
        <div className="p-3 pt-0 border-t border-neutral-200/50 dark:border-neutral-800/50 mt-1">
          {children}
        </div>
      )}
    </div>
  )
}

function PropertiesSection() {
  const { 
    selectedIds, objects, updateObject, addObject, 
    activeTool, brushSettings, setBrushSettings, 
    shapeSettings, setShapeSettings,
    panX, panY, zoom
  } = useHaloboardStore()

  const fileInputRef = useRef<HTMLInputElement>(null)

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return
    const reader = new FileReader()
    reader.onload = (event) => {
      const src = event.target?.result as string
      const img = new Image()
      img.onload = () => {
        addObject({
          id: `image-${Date.now()}`,
          type: "image",
          layerId: "layer-1", 
          transform: { x: -panX / zoom + 100, y: -panY / zoom + 100, rotation: 0, scaleX: 1, scaleY: 1 },
          data: { src, width: 200, height: 200 * (img.height / img.width), opacity: 1, blendMode: 'normal' },
        })
      }
      img.src = src
    }
    reader.readAsDataURL(file)
    e.target.value = ''
  }

  // --- TOOL SETTINGS ---

  if (activeTool === 'shape') {
    return (
      <div className="flex flex-col gap-3 pt-2">
        <div className="flex items-center justify-between">
           <span className="text-xs font-medium text-neutral-500 uppercase tracking-wider">Shape Tool Config</span>
        </div>
        
        <div>
          <label className="text-[10px] text-neutral-500 mb-1 block">Shape Type</label>
          <select 
            className="w-full h-8 rounded-md border border-neutral-200 bg-white text-xs px-2 dark:bg-neutral-800 dark:border-neutral-700"
            value={shapeSettings.shapeType}
            onChange={(e) => setShapeSettings({ shapeType: e.target.value as any })}
          >
            <option value="rectangle">Rectangle</option>
            <option value="rounded_rectangle">Rounded Rectangle</option>
            <option value="ellipse">Ellipse</option>
            <option value="circle">Circle</option>
            <option value="triangle">Triangle</option>
            <option value="line">Line</option>
            <option value="arrow">Arrow</option>
            <option value="star">Star</option>
            <option value="cloud">Cloud</option>
            <option value="speech_bubble">Speech Bubble</option>
          </select>
        </div>

        <div className="grid grid-cols-2 gap-2">
          <div>
            <label className="text-[10px] text-neutral-500 mb-1 block">Fill</label>
            <div className="flex items-center gap-2">
              <input
                type="color"
                value={shapeSettings.fillColor}
                onChange={(e) => setShapeSettings({ fillColor: e.target.value })}
                className="size-6 border-0 p-0 rounded cursor-pointer"
              />
            </div>
          </div>
          <div>
            <label className="text-[10px] text-neutral-500 mb-1 block">Stroke</label>
            <div className="flex items-center gap-2">
              <input
                type="color"
                value={shapeSettings.strokeColor}
                onChange={(e) => setShapeSettings({ strokeColor: e.target.value })}
                className="size-6 border-0 p-0 rounded cursor-pointer"
              />
            </div>
          </div>
        </div>

        <div>
          <label className="text-[10px] text-neutral-500 mb-1 block">Border Type</label>
          <Select 
            value={shapeSettings.borderType} 
            onValueChange={(value: any) => setShapeSettings({ borderType: value })}
          >
            <SelectTrigger className="w-full h-8 text-xs">
              <SelectValue placeholder="Select border" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="solid">
                <div className="flex items-center gap-2 w-24"><div className="h-0.5 w-full bg-current" /></div>
              </SelectItem>
              <SelectItem value="dashed">
                <div className="flex items-center gap-2 w-24"><div className="h-0.5 w-full border-t-2 border-dashed border-current" /></div>
              </SelectItem>
              <SelectItem value="dotted">
                <div className="flex items-center gap-2 w-24"><div className="h-0.5 w-full border-t-2 border-dotted border-current" /></div>
              </SelectItem>
              <SelectItem value="bold">
                <div className="flex items-center gap-2 w-24"><div className="h-1 w-full bg-current" /></div>
              </SelectItem>
              <SelectItem value="none">
                <span className="text-xs text-muted-foreground">None</span>
              </SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>
    )
  }

  if (activeTool === 'brush' || activeTool === 'eraser') {
    return (
      <div className="flex flex-col gap-4 pt-2">
        <div className="flex items-center justify-between">
           <span className="text-xs font-medium text-neutral-500 uppercase tracking-wider">{activeTool === 'brush' ? 'Brush' : 'Eraser'} Settings</span>
        </div>
        
        <div>
          <label className="mb-2 flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400">
            <span>Size</span>
            <span className="font-medium">{brushSettings.size}px</span>
          </label>
          <Slider
            value={[brushSettings.size]}
            onValueChange={([value]) => setBrushSettings({ size: value })}
            min={1} max={50} step={1}
            className="w-full"
          />
        </div>

        {activeTool === 'brush' && (
          <div>
            <label className="mb-2 block text-xs text-neutral-600 dark:text-neutral-400">Color</label>
            <div className="flex flex-wrap gap-2">
              {["#000000", "#EF4444", "#F97316", "#EAB308", "#22C55E", "#0A84FF", "#8B5CF6", "#EC4899"].map((color) => (
                <button
                  key={color}
                  onClick={() => setBrushSettings({ color })}
                  className={cn(
                    "size-6 rounded-full border-2 transition-transform hover:scale-110",
                    brushSettings.color === color ? "border-[#0A84FF] ring-2 ring-[#0A84FF]/30" : "border-transparent"
                  )}
                  style={{ backgroundColor: color }}
                />
              ))}
              <input 
                type="color" 
                value={brushSettings.color} 
                onChange={(e) => setBrushSettings({ color: e.target.value })}
                className="size-6 p-0 border-0 rounded-full overflow-hidden cursor-pointer"
              />
            </div>
          </div>
        )}
      </div>
    )
  }

  if (activeTool === 'image') {
    return (
      <div className="flex flex-col gap-4 pt-2">
        <div className="flex items-center justify-between">
           <span className="text-xs font-medium text-neutral-500 uppercase tracking-wider">Image Tool</span>
        </div>
        <input type="file" accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} />
        <Button onClick={() => fileInputRef.current?.click()} className="w-full gap-2">
          <Upload className="size-4" /> Import Image
        </Button>
      </div>
    )
  }

  // --- OBJECT PROPERTIES ---

  const selectedObject = selectedIds.length > 0 ? objects.find((obj) => obj.id === selectedIds[selectedIds.length - 1]) : null

  if (!selectedObject) return <div className="text-xs text-neutral-500 p-2 text-center italic">Select an object or tool to edit properties</div>

  return (
    <div className="flex flex-col gap-3 pt-2">
      
      {selectedObject.type === "shape" && (
        <div className="space-y-3 pb-3 border-b border-neutral-200 dark:border-neutral-700">
          <div>
            <label className="text-[10px] text-neutral-500 mb-1 block">Shape Type</label>
            <select 
              className="w-full h-8 rounded-md border border-neutral-200 bg-white text-xs px-2 dark:bg-neutral-800 dark:border-neutral-700"
              value={(selectedObject.data as any).shapeType}
              onChange={(e) => updateObject(selectedObject.id, { data: { ...(selectedObject.data as any), shapeType: e.target.value } })}
            >
              <option value="rectangle">Rectangle</option>
              <option value="rounded_rectangle">Rounded Rectangle</option>
              <option value="ellipse">Ellipse</option>
              <option value="circle">Circle</option>
              <option value="triangle">Triangle</option>
              <option value="line">Line</option>
              <option value="arrow">Arrow</option>
              <option value="star">Star</option>
              <option value="cloud">Cloud</option>
              <option value="speech_bubble">Speech Bubble</option>
            </select>
          </div>
          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className="text-[10px] text-neutral-500 mb-1 block">Fill Color</label>
              <div className="flex items-center gap-2">
                <input
                  type="color"
                  value={(selectedObject.data as any).fillColor}
                  onChange={(e) => updateObject(selectedObject.id, { data: { ...(selectedObject.data as any), fillColor: e.target.value } })}
                  className="size-6 border-0 p-0 rounded cursor-pointer"
                />
              </div>
            </div>
            <div>
              <label className="text-[10px] text-neutral-500 mb-1 block">Stroke Color</label>
              <div className="flex items-center gap-2">
                <input
                  type="color"
                  value={(selectedObject.data as any).strokeColor}
                  onChange={(e) => updateObject(selectedObject.id, { data: { ...(selectedObject.data as any), strokeColor: e.target.value } })}
                  className="size-6 border-0 p-0 rounded cursor-pointer"
                />
              </div>
            </div>
          </div>
          <div>
            <label className="text-[10px] text-neutral-500 mb-1 block">Border Type</label>
            <Select 
              value={(selectedObject.data as any).borderType || 'solid'} 
              onValueChange={(value: any) => updateObject(selectedObject.id, { data: { ...(selectedObject.data as any), borderType: value } })}
            >
              <SelectTrigger className="w-full h-8 text-xs">
                <SelectValue placeholder="Select border" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="solid">
                  <div className="flex items-center gap-2 w-24"><div className="h-0.5 w-full bg-current" /></div>
                </SelectItem>
                <SelectItem value="dashed">
                  <div className="flex items-center gap-2 w-24"><div className="h-0.5 w-full border-t-2 border-dashed border-current" /></div>
                </SelectItem>
                <SelectItem value="dotted">
                  <div className="flex items-center gap-2 w-24"><div className="h-0.5 w-full border-t-2 border-dotted border-current" /></div>
                </SelectItem>
                <SelectItem value="bold">
                  <div className="flex items-center gap-2 w-24"><div className="h-1 w-full bg-current" /></div>
                </SelectItem>
                <SelectItem value="none">
                  <span className="text-xs text-muted-foreground">None</span>
                </SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>
      )}

      {/* ... Image Properties (Unchanged) ... */}
      {selectedObject.type === "image" && (
        <div className="space-y-3 pb-3 border-b border-neutral-200 dark:border-neutral-700">
          <div className="flex items-center gap-2">
            <ImageIcon className="size-4 text-neutral-500" />
            <span className="text-xs font-medium">Image Settings</span>
          </div>

          <div>
            <label className="mb-2 flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400">
              <span>Opacity</span>
              <span className="font-medium">{Math.round((selectedObject.data as any).opacity * 100)}%</span>
            </label>
            <Slider
              value={[(selectedObject.data as any).opacity * 100]}
              onValueChange={([value]) => updateObject(selectedObject.id, { data: { ...(selectedObject.data as any), opacity: value / 100 } })}
              min={0} max={100} step={1}
              className="w-full"
            />
          </div>
          <div>
            <label className="text-[10px] text-neutral-500 mb-1 block">Blend Mode</label>
            <select 
              className="w-full h-8 rounded-md border border-neutral-200 bg-white text-xs px-2 dark:bg-neutral-800 dark:border-neutral-700"
              value={(selectedObject.data as any).blendMode || 'normal'}
              onChange={(e) => updateObject(selectedObject.id, { data: { ...(selectedObject.data as any), blendMode: e.target.value } })}
            >
              <option value="normal">Normal</option>
              <option value="multiply">Multiply</option>
              <option value="screen">Screen</option>
              <option value="overlay">Overlay</option>
            </select>
          </div>
        </div>
      )}

      {/* Transform and Rotation (Unchanged) */}
      <div>
        <label className="mb-2 block text-xs font-medium text-neutral-600 dark:text-neutral-400">Position</label>
        <div className="grid grid-cols-2 gap-2">
          <div>
            <label className="mb-1 block text-xs text-neutral-500">X</label>
            <input
              type="number"
              value={Math.round(selectedObject.transform.x)}
              onChange={(e) => updateObject(selectedObject.id, { transform: { ...selectedObject.transform, x: parseFloat(e.target.value) } })}
              className="w-full rounded-lg border border-neutral-200 bg-white px-2 py-1 text-sm dark:border-neutral-700 dark:bg-neutral-800"
            />
          </div>
          <div>
            <label className="mb-1 block text-xs text-neutral-500">Y</label>
            <input
              type="number"
              value={Math.round(selectedObject.transform.y)}
              onChange={(e) => updateObject(selectedObject.id, { transform: { ...selectedObject.transform, y: parseFloat(e.target.value) } })}
              className="w-full rounded-lg border border-neutral-200 bg-white px-2 py-1 text-sm dark:border-neutral-700 dark:bg-neutral-800"
            />
          </div>
        </div>
      </div>

      <div>
        <label className="mb-2 flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400">
          <span>Rotation</span>
          <span className="font-medium">{Math.round(selectedObject.transform.rotation)}Â°</span>
        </label>
        <Slider
          value={[selectedObject.transform.rotation]}
          onValueChange={([value]) => updateObject(selectedObject.id, { transform: { ...selectedObject.transform, rotation: value } })}
          min={-180} max={180} step={1}
          className="w-full"
        />
      </div>
    </div>
  )
}

function LayersSection() {
  const { layers, activeLayerId, setActiveLayer, updateLayer, deleteLayer, addLayer, objects, moveLayer, moveObjectToLayer } = useHaloboardStore()
  const [expandedLayers, setExpandedLayers] = useState<string[]>(['layer-1'])

  const toggleExpand = (id: string) => {
    setExpandedLayers(prev => prev.includes(id) ? prev.filter(l => l !== id) : [...prev, id])
  }

  return (
    <div className="flex flex-col gap-2 pt-2">
      <div className="flex items-center justify-between mb-2">
        <span className="text-[10px] text-neutral-400 uppercase font-semibold tracking-wider">Stack</span>
        <Button variant="ghost" size="sm" onClick={addLayer} className="h-6 px-2 text-xs gap-1">
          <Plus className="size-3" /> New Layer
        </Button>
      </div>

      {layers.map((layer, index) => (
        <div 
          key={layer.id} 
          className={cn(
            "rounded-lg border transition-all",
            activeLayerId === layer.id 
              ? "border-[#0A84FF] bg-[#0A84FF]/5 dark:bg-[#0A84FF]/10" 
              : "border-neutral-100 bg-white/50 dark:border-neutral-800 dark:bg-neutral-800/30"
          )}
        >
          {/* Layer Header */}
          <div 
            className="flex items-center gap-2 p-2 cursor-pointer"
            onClick={() => setActiveLayer(layer.id)}
          >
            <button onClick={(e) => { e.stopPropagation(); toggleExpand(layer.id) }} className="p-0.5 rounded hover:bg-black/5">
              {expandedLayers.includes(layer.id) ? <ChevronDown className="size-3" /> : <ChevronRight className="size-3" />}
            </button>
            
            <input
              type="text"
              value={layer.name}
              onClick={(e) => e.stopPropagation()}
              onChange={(e) => updateLayer(layer.id, { name: e.target.value })}
              className="bg-transparent text-sm font-medium text-neutral-800 outline-none dark:text-neutral-200 w-full"
            />

            <div className="flex items-center gap-0.5">
              {/* Move Layer Up/Down */}
              <div className="flex flex-col mr-1">
                <button 
                  onClick={(e) => { e.stopPropagation(); moveLayer(layer.id, 'up') }} 
                  disabled={index === 0}
                  className="hover:text-[#0A84FF] disabled:opacity-20"
                >
                  <ChevronUp className="size-3" />
                </button>
                <button 
                  onClick={(e) => { e.stopPropagation(); moveLayer(layer.id, 'down') }} 
                  disabled={index === layers.length - 1}
                  className="hover:text-[#0A84FF] disabled:opacity-20"
                >
                  <ChevronDown className="size-3" />
                </button>
              </div>

              <button onClick={(e) => { e.stopPropagation(); updateLayer(layer.id, { visible: !layer.visible }) }} className="rounded p-1 hover:bg-black/5 dark:hover:bg-white/5">
                {layer.visible ? <Eye className="size-3.5 text-neutral-600 dark:text-neutral-400" /> : <EyeOff className="size-3.5 text-neutral-400" />}
              </button>
              <button onClick={(e) => { e.stopPropagation(); updateLayer(layer.id, { locked: !layer.locked }) }} className="rounded p-1 hover:bg-black/5 dark:hover:bg-white/5">
                {layer.locked ? <Lock className="size-3.5 text-neutral-600 dark:text-neutral-400" /> : <LockOpen className="size-3.5 text-neutral-400" />}
              </button>
              {layers.length > 1 && (
                <button onClick={(e) => { e.stopPropagation(); deleteLayer(layer.id) }} className="rounded p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">
                  <Trash2 className="size-3.5" />
                </button>
              )}
            </div>
          </div>

          {/* Layer Objects List */}
          {expandedLayers.includes(layer.id) && (
            <div className="px-2 pb-2 space-y-1 border-t border-neutral-200/50 dark:border-neutral-700/50 mt-1 pt-1">
              {layer.objectIds.length === 0 ? (
                <div className="text-[10px] text-neutral-400 pl-6 italic">Empty layer</div>
              ) : (
                layer.objectIds.map((objId) => {
                  const obj = objects.find(o => o.id === objId)
                  if (!obj) return null
                  return (
                    <div key={objId} className="flex items-center justify-between group pl-6 pr-2 py-1 rounded hover:bg-black/5 dark:hover:bg-white/5 text-xs">
                      <span className="truncate max-w-[100px] text-neutral-600 dark:text-neutral-400">
                        {obj.type} {obj.type === 'text' ? `"${(obj.data as any).content.substring(0, 8)}..."` : ''}
                      </span>
                      
                      {/* Move Object Controls */}
                      <div className="opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                        <select 
                          className="text-[10px] bg-transparent border border-neutral-300 rounded px-1 cursor-pointer"
                          onChange={(e) => moveObjectToLayer(objId, e.target.value)}
                          value={layer.id}
                        >
                          {layers.map(l => (
                            <option key={l.id} value={l.id}>{l.name}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                  )
                })
              )}
            </div>
          )}
        </div>
      ))}
    </div>
  )
}

function HistorySection() {
  const { history, historyIndex, setHistoryIndex, undo, redo } = useHaloboardStore()
  return (
    <div className="flex flex-col gap-2 pt-2">
      <div className="flex gap-2 mb-2">
        <Button variant="outline" size="sm" onClick={undo} disabled={historyIndex <= 0} className="flex-1 gap-1 h-8">
          <RotateCcw className="size-3" /> Undo
        </Button>
        <Button variant="outline" size="sm" onClick={redo} disabled={historyIndex >= history.length - 1} className="flex-1 gap-1 h-8">
          <Clock className="size-3" /> Redo
        </Button>
      </div>
      <ScrollArea className="h-32 rounded-md border border-neutral-200 dark:border-neutral-800 bg-white/50 dark:bg-neutral-900/50">
        <div className="p-2 space-y-1">
          {history.map((_, i) => (
            <button key={i} onClick={() => setHistoryIndex(i)} className={cn("w-full text-left px-2 py-1 text-xs rounded transition-colors truncate", i === historyIndex ? "bg-[#0A84FF]/10 text-[#0A84FF] font-medium" : "text-neutral-600 hover:bg-black/5 dark:text-neutral-400 dark:hover:bg-white/5")}>
              {i === 0 ? "Initial State" : `Action ${i}`} {i === historyIndex && "(Current)"}
            </button>
          ))}
        </div>
      </ScrollArea>
    </div>
  )
}

function ChatSection() {
  return <div className="flex flex-col h-64 pt-2"><div className="flex-1 flex items-center justify-center text-xs text-neutral-400">Chat disabled in offline mode</div></div>
}

export function RightPanel() {
  return (
    <aside className="fixed right-4 top-20 bottom-4 w-72 z-30 flex flex-col gap-3 pointer-events-none">
      <div className="flex-1 overflow-y-auto pr-1 pb-1 pointer-events-auto flex flex-col gap-3">
        <PanelSection title="Properties"><PropertiesSection /></PanelSection>
        <PanelSection title="Layers"><LayersSection /></PanelSection>
        <PanelSection title="History" defaultOpen={false}><HistorySection /></PanelSection>
        <PanelSection title="Chat" defaultOpen={false}><ChatSection /></PanelSection>
      </div>
    </aside>
  )
}
